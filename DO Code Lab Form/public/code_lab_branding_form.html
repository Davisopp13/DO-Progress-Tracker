<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DO Code Lab Design Questionnaire</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to ensure the page looks polished */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
            /* Light off-white background */
        }

        .form-container {
            max-width: 800px;
        }

        /* Custom focus color to match the DO Code Lab green */
        input:focus,
        textarea:focus,
        select:focus {
            border-color: #38a169 !important;
            box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.4) !important;
        }
    </style>
    <!-- Firebase Global Variables are automatically provided by the platform -->
    <script type="text/javascript">
        // Ensure global variables are set, using defaults if not provided (e.g., when viewing locally)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Local development Firebase configuration
         * This allows the form to work when testing locally before deployment
         */
        const localFirebaseConfig = {
            apiKey: "AIzaSyCAihs9u9X4yefvHfRklS8BalZhTFr5Hr4",
            authDomain: "do-code-lab-form.firebaseapp.com",
            projectId: "do-code-lab-form",
            storageBucket: "do-code-lab-form.firebasestorage.app",
            messagingSenderId: "1058152711151",
            appId: "1:1058152711151:web:f376e8a09afa20b6a3ac1a"
        };

        /**
         * Fallback mechanism to get Firebase config from the hosting environment.
         * This endpoint is automatically available on Firebase Hosting.
         */
        async function getFirebaseConfig() {
            if (Object.keys(firebaseConfig).length === 0) {
                try {
                    const response = await fetch('/__/firebase/init.json');
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (e) {
                    console.warn("Failed to fetch config from /__/firebase/init.json:", e);
                    console.log("Using local Firebase configuration for development");
                    // Use local config when Firebase Hosting config is unavailable
                    return localFirebaseConfig;
                }
            }
            return firebaseConfig;
        }
    </script>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <div id="loading-overlay"
        class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-l-2 border-green-700"></div>
            <p class="mt-4 text-gray-700 font-semibold">Submitting...</p>
        </div>
    </div>

    <!-- Message Box Container -->
    <div id="message-box"
        class="fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition-transform duration-300 transform translate-x-full"
        style="min-width: 300px;"></div>


    <div class="form-container w-full bg-white rounded-xl shadow-2xl p-6 sm:p-10">

        <!-- Header with Logo and Navigation -->
        <header class="flex justify-between items-center mb-6 border-b pb-4 border-gray-200">
            <div class="flex items-center space-x-3">
                <!-- Corrected logo path with hyphen -->
                <img src="do-code-lab-logo.png" alt="DO Code Lab Logo" class="h-40 w-auto">
            </div>
            <a href="code_lab_dashboard.html"
                class="text-sm font-medium text-green-700 hover:text-green-900 transition duration-150">
                View Submissions &rarr;
            </a>
        </header>

        <h2 class="text-3xl sm:text-4xl font-extrabold text-green-800 mb-2">Design Questionnaire</h2>
        <p class="text-gray-600 mb-8">Help us capture the vision for your new web presence and brand aesthetic.</p>

        <form id="design-form" onsubmit="submitForm(event)">
            <div class="space-y-8">

                <!-- Q1: Color/Aesthetic -->
                <div>
                    <label for="aesthetic" class="block text-lg font-semibold text-gray-700 mb-2">1. Do you have a color
                        and/or aesthetic picked out yet?</label>
                    <textarea id="aesthetic" name="aesthetic" rows="3"
                        placeholder="Describe any initial ideas for colors, textures, or general mood."
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-green-500 focus:border-green-500"></textarea>
                </div>

                <!-- Q2: Logo -->
                <div>
                    <label class="block text-lg font-semibold text-gray-700 mb-2">2. Do you have a finalized logo, or do
                        you need one designed?</label>
                    <div class="mt-1 space-y-2">
                        <div class="flex items-center">
                            <input id="logo-finalized" name="logo" type="radio" value="Finalized Logo" required
                                class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300">
                            <label for="logo-finalized" class="ml-3 block text-base font-medium text-gray-700">Finalized
                                Logo (Ready to use)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="logo-needs-design" name="logo" type="radio" value="Needs Design"
                                class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300">
                            <label for="logo-needs-design" class="ml-3 block text-base font-medium text-gray-700">Needs
                                Design (Start from scratch or draft)</label>
                        </div>
                    </div>
                </div>

                <!-- Q3: Vibe -->
                <div>
                    <label class="block text-lg font-semibold text-gray-700 mb-2">3. What's the core vibe you want for
                        the website/brand?</label>
                    <div class="mt-1 space-y-2">
                        <div class="flex items-center">
                            <input id="vibe-refined" name="vibe" type="radio" value="Refined and Elegant" required
                                class="vibe-radio focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"
                                onclick="toggleElse(false)">
                            <label for="vibe-refined" class="ml-3 block text-base font-medium text-gray-700">Refined and
                                Elegant</label>
                        </div>
                        <div class="flex items-center">
                            <input id="vibe-warm" name="vibe" type="radio" value="Warm and Approachable"
                                class="vibe-radio focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"
                                onclick="toggleElse(false)">
                            <label for="vibe-warm" class="ml-3 block text-base font-medium text-gray-700">Warm and
                                Approachable</label>
                        </div>
                        <div class="flex items-center">
                            <input id="vibe-modern" name="vibe" type="radio" value="Modern and Minimal"
                                class="vibe-radio focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"
                                onclick="toggleElse(false)">
                            <label for="vibe-modern" class="ml-3 block text-base font-medium text-gray-700">Modern and
                                Minimal</label>
                        </div>
                        <div class="flex items-center">
                            <input id="vibe-craft" name="vibe" type="radio" value="Craft-focused and Artisanal"
                                class="vibe-radio focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"
                                onclick="toggleElse(false)">
                            <label for="vibe-craft" class="ml-3 block text-base font-medium text-gray-700">Craft-focused
                                and Artisanal</label>
                        </div>
                        <div class="flex items-center">
                            <input id="vibe-else" name="vibe" type="radio"
                                value="Something else (Please describe below)"
                                class="vibe-radio focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300"
                                onclick="toggleElse(true)">
                            <label for="vibe-else" class="ml-3 block text-base font-medium text-gray-700">Something else
                                (Please describe below)</label>
                        </div>
                    </div>

                    <!-- Dynamic Text Box for "Something Else" -->
                    <div id="vibe-else-container" class="mt-4 hidden transition-all duration-300 ease-in-out">
                        <label for="vibe-else-text" class="block text-sm font-medium text-gray-500 mb-1">Describe your
                            desired vibe:</label>
                        <textarea id="vibe-else-text" name="vibe_else_description" rows="2"
                            placeholder="e.g., Industrial and Bold, or Playful and Cartoonish."
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-green-500 focus:border-green-500"></textarea>
                    </div>
                </div>

                <!-- Q4: Color Preferences -->
                <div>
                    <label for="color-preferences" class="block text-lg font-semibold text-gray-700 mb-2">4. Do you have
                        any color palette preferences or specific colors to avoid?</label>
                    <textarea id="color-preferences" name="color_preferences" rows="3"
                        placeholder="e.g., 'Warm earth tones are great, but no bright reds or oranges.'"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-green-500 focus:border-green-500"></textarea>
                </div>

                <!-- Q5: Typeface Direction -->
                <div>
                    <label class="block text-lg font-semibold text-gray-700 mb-2">5. Typeface direction?</label>
                    <div class="mt-1 space-y-2">
                        <div class="flex items-center">
                            <input id="typeface-serif" name="typeface" type="radio" value="Classic Serif" required
                                class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300">
                            <label for="typeface-serif" class="ml-3 block text-base font-medium text-gray-700">Classic
                                Serif (Traditional, authoritative)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="typeface-sans" name="typeface" type="radio" value="Modern Sans-serif"
                                class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300">
                            <label for="typeface-sans" class="ml-3 block text-base font-medium text-gray-700">Modern
                                Sans-serif (Clean, minimal, high-tech)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="typeface-script" name="typeface" type="radio" value="Handcrafted Script"
                                class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300">
                            <label for="typeface-script"
                                class="ml-3 block text-base font-medium text-gray-700">Handcrafted Script (Personal,
                                artisanal)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="typeface-combination" name="typeface" type="radio" value="Combination"
                                class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300">
                            <label for="typeface-combination"
                                class="ml-3 block text-base font-medium text-gray-700">Combination (A mix for
                                headings/body)</label>
                        </div>
                    </div>
                </div>

                <!-- Q6: Brand Emulation -->
                <div>
                    <label for="brand-emulation" class="block text-lg font-semibold text-gray-700 mb-2">6. Are there any
                        brands or companies whose design aesthetic resonates with you that you might want to
                        emulate?</label>
                    <textarea id="brand-emulation" name="brand_emulation" rows="3"
                        placeholder="List 1-3 brands and what you like about their design."
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-green-500 focus:border-green-500"></textarea>
                </div>

                <!-- Submission Button -->
                <div class="pt-5">
                    <button type="submit"
                        class="w-full flex justify-center py-3 px-6 border border-transparent rounded-md shadow-lg text-lg font-bold text-white bg-green-700 hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                        Submit Questionnaire
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level to help with debugging
        setLogLevel('Debug');

        let app, db, auth, userId;
        const form = document.getElementById('design-form');
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageBox = document.getElementById('message-box');

        /** Displays a notification message */
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = isError ? '#dc2626' : '#10b981'; // Red for error, Green for success
            // Show the box by sliding it into view
            messageBox.classList.remove('translate-x-full');

            setTimeout(() => {
                // Hide the box by sliding it out of view
                messageBox.classList.add('translate-x-full');
            }, 5000);
        }

        /** Initializes Firebase app and authenticates the user */
        async function initFirebaseAndAuth() {
            try {
                // 1. Get Config (using fallback if global variable is missing)
                const config = await getFirebaseConfig();

                if (Object.keys(config).length === 0) {
                    showMessage("Error: Firebase configuration is missing. Cannot save data.", true);
                    return;
                }

                app = initializeApp(config); // Use the fetched config
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Auth attempt
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Wait for auth state to be confirmed
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        showMessage("Connection established. Ready to save data.");
                    } else {
                        userId = crypto.randomUUID();
                        showMessage("Warning: Signed in anonymously.", true);
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage("Initialization failed. Cannot save data. Details in console.", true);
            }
        }

        /** Handles form submission and saves data to Firestore */
        window.submitForm = async function (event) {
            event.preventDefault();
            loadingOverlay.classList.remove('hidden');

            if (!userId) {
                showMessage("Error: Authentication not complete. Please try again.", true);
                loadingOverlay.classList.add('hidden');
                return;
            }

            const formData = new FormData(form);
            const data = {
                submittedAt: serverTimestamp(),
                submittedBy: userId,
                // General Questions
                aesthetic: formData.get('aesthetic') || '',
                logo: formData.get('logo') || '',
                vibe: formData.get('vibe') || '',
                // If 'Something else' was selected, include the description
                vibe_else_description: (formData.get('vibe') === 'Something else (Please describe below)') ? formData.get('vibe_else_description') : '',
                color_preferences: formData.get('color_preferences') || '',
                typeface: formData.get('typeface') || '',
                brand_emulation: formData.get('brand_emulation') || '',
            };

            try {
                // Define the collection path based on security rules: /artifacts/{appId}/users/{userId}/code_lab_design_questionnaires
                const collectionPath = `artifacts/${appId}/users/${userId}/code_lab_design_questionnaires`;
                const newDocRef = doc(collection(db, collectionPath));

                await setDoc(newDocRef, data);

                showMessage("Success! Your questionnaire has been saved.");
                form.reset(); // Clear the form on successful submission

            } catch (error) {
                console.error("Firestore Save Error:", error);
                showMessage("Submission Failed: " + error.message, true);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        /** Toggles the visibility of the "Something else" text area for Q3 */
        window.toggleElse = function (show) {
            const container = document.getElementById('vibe-else-container');
            const textarea = document.getElementById('vibe-else-text');

            if (show) {
                container.classList.remove('hidden');
                setTimeout(() => { // Use timeout to ensure smooth transition
                    container.style.maxHeight = container.scrollHeight + "px";
                }, 10);
                textarea.setAttribute('required', 'required');
            } else {
                container.style.maxHeight = '0';
                textarea.removeAttribute('required');
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 300); // Wait for the transition to finish
            }
        }

        // Start initialization on page load
        initFirebaseAndAuth();

    </script>
</body>

</html>